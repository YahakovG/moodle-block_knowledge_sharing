define(["jquery","core/tree","core/ajax","core/url"],function(r,e,o,n){var i={},d=function(){r("#group_tag, #group_category").removeClass("active").addClass("inactive"),r("#"+i.activeGroup).addClass("active").removeClass("inactive")},t=function(){r("#group_tag, #group_category").on("click",function(e){if(e.preventDefault(),!(0<=r(e.currentTarget).attr("class").indexOf("inactive"))){var a="tag"==r(e.currentTarget).attr("id").replace("group_","");u(a)}})},s=function(){r("#"+i.searchid).on("input",function(e){var a=r(this).val().toUpperCase();r("#"+i.treeid+" li").each(function(){-1<r(this).text().toUpperCase().indexOf(a)?r(this).show():r(this).hide()})})},l=function(){new e("#"+i.treeid)},c=function(){r(".knowledge_sharing_module").on("dragstart",function(e){(e=e.originalEvent).dataTransfer.dropEffect="copy",e.dataTransfer.setData("text",r(this).attr("data-module"))}),r("li.section").on("dragover",function(e){e.preventDefault(),r(this).find(".dndupload-preview").removeClass("dndupload-hidden")}).on("dragleave",function(e){r(this).find(".dndupload-preview").addClass("dndupload-hidden")}).on("drop",function(e){var i=this;e.preventDefault(),e=e.originalEvent,r(i).find(".dndupload-preview").addClass("dndupload-hidden");var a=r(i).find('span[data-itemtype="sectionname"]').attr("data-itemid"),n=e.dataTransfer.getData("text");a&&(p(r(i)),o.call([{methodname:"block_knowledge_sharing_external_duplicte",args:{section:a,module:n,course:r("#course").attr("value")}}])[0].done(function(e){g(r(i));var a=JSON.parse(e),n=r(i).find("ul.section"),t=r.parseHTML(a.module);n.find("li.dndupload-preview").before(t),M.course_dndupload.add_editing(r(t).attr("id"))}).fail(function(e){g(r(i)),console.log(e)}))})},u=function(n){var t=r("#"+i.treeid);t.hide(),p(t.parent()),o.call([{methodname:"block_knowledge_sharing_external_group",args:{tag:n,course:r("#course").val()}}])[0].done(function(e){g(t.parent());var a=JSON.parse(e);t.html(a.content),i.activeGroup=n?"group_category":"group_tag",l(),c(),s(),d(),t.show()}).fail(function(e){g(t.parent()),t.show(),console.log(e)})},p=function(e){e.addClass("updating");var a=e.find("img.spinner");a.length?a.show():(a=r("<img/>").attr("src",n.imageUrl("i/loading_small")).addClass("spinner").addClass("smallicon"),e.append(a))},g=function(e){e.removeClass("updating"),e.find("img.spinner").hide()};return{init_tree:function(e,a){i.treeid=e,i.activeGroup="group_tag",i.searchid=a,i.lastValue="",l(),c(),s(),d(),t()}}});