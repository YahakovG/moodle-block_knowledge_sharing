define(["jquery","core/tree","core/ajax","core/url"],function(f,o,j,a){var c;var g={};var m=function(p,q){g.treeid=p;g.activeGroup="group_tag";g.searchid=q;g.lastValue="";b();k();n();h();l()};var h=function(){f("#group_tag, #group_category").removeClass("active").addClass("inactive");f("#"+g.activeGroup).addClass("active").removeClass("inactive")};var l=function(){f("#group_tag, #group_category").on("click",function(q){q.preventDefault();if(f(q.currentTarget).attr("class").indexOf("inactive")>=0){return}var p=f(q.currentTarget).attr("id").replace("group_","")=="tag";i(p)})};var n=function(){f("#"+g.searchid).on("input",function(p){var q=f(this).val().toUpperCase();f("#"+g.treeid+" li").each(function(){if(f(this).text().toUpperCase().indexOf(q)>-1){f(this).show()}else{f(this).hide()}})})};var b=function(){new o("#"+g.treeid)};var k=function(){f(".knowledge_sharing_module").on("dragstart",function(p){p=p.originalEvent;p.dataTransfer.dropEffect="copy";p.dataTransfer.setData("text",f(this).attr("data-module"))}).on("dragend",function(p){this.drop_target=null;f(".dndupload-preview").addClass("dndupload-hidden")});f("li.section").on("dragenter",function(p){p.stopPropagation();p.preventDefault();this.drop_target=p.target;f(this).find(".dndupload-preview").removeClass("dndupload-hidden")}).on("dragover",function(p){p.stopPropagation();p.preventDefault()}).on("dragleave",function(p){p.stopPropagation();p.preventDefault();if(this.drop_target===p.target){f(this).find(".dndupload-preview").addClass("dndupload-hidden")}}).on("drop",function(s){var q=this;s.stopPropagation();s.preventDefault();this.drop_target=null;s=s.originalEvent;f(q).find(".dndupload-preview").addClass("dndupload-hidden");var r=f(q).find('span[data-itemtype="sectionname"]').attr("data-itemid");var p=s.dataTransfer.getData("text");if(r){e(f(q));j.call([{methodname:"block_knowledge_sharing_external_duplicte",args:{section:r,module:p,course:f("#course").attr("value")}}])[0].done(function(v){d(f(q));var t=JSON.parse(v);var w=f(q).find("ul.section");var u=f.parseHTML(t.module);w.find("li.dndupload-preview").before(u);M.course_dndupload.add_editing(f(u).attr("id"))}).fail(function(t){d(f(q));console.log(t)})}})};var i=function(p){var q=f("#"+g.treeid);q.hide();e(q.parent());j.call([{methodname:"block_knowledge_sharing_external_group",args:{tag:p,course:f("#course").val()}}])[0].done(function(s){d(q.parent());var r=JSON.parse(s);q.html(r.content);g.activeGroup=p?"group_category":"group_tag";b();k();n();h();q.show()}).fail(function(r){d(q.parent());q.show();console.log(r)})};var e=function(p){p.addClass("updating");var q=p.find("img.spinner");if(q.length){q.show()}else{q=f("<img/>").attr("src",a.imageUrl("i/loading_small")).addClass("spinner").addClass("smallicon");p.append(q)}};var d=function(p){p.removeClass("updating");p.find("img.spinner").hide()};return{init_tree:m}});